import streamlit as st
import google.generativeai as genai

# 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞
st.set_page_config(page_title="AI –ï–∫–æ-–ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç", page_icon="üå±", layout="wide")

# 2. –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ API –∫–ª—é—á–∞ –æ—Ç Streamlit Secrets
# –í Streamlit Cloud —Ç–æ–≤–∞ —Å–µ –Ω–∞—Å—Ç—Ä–æ–π–≤–∞ –≤ TOML —Ñ–æ—Ä–º–∞—Ç
if "GOOGLE_API_KEY" in st.secrets:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
else:
    st.error("–õ–∏–ø—Å–≤–∞ API –∫–ª—é—á. –ú–æ–ª—è, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≥–æ –≤ Streamlit Secrets.")

# 3. –°–∏—Å—Ç–µ–º–Ω–∏—è—Ç –ü—Ä–æ–º–ø—Ç (–°–∫—Ä–∏—Ç–∏—Ç–µ –∑–Ω–∞–Ω–∏—è –æ—Ç –ª–µ–∫—Ü–∏–∏—Ç–µ)
# –¢—É–∫ —Å–º–µ –≤–≥—Ä–∞–¥–∏–ª–∏ –ª–æ–≥–∏–∫–∞—Ç–∞ –æ—Ç XML —Ñ–∞–π–ª–æ–≤–µ—Ç–µ (–ê–∑–æ—Ç, –ï—Ä–æ–∑–∏—è, –§–ü–ß, –í–æ–¥–∏)
SYSTEM_PROMPT = """
–¢–∏ —Å–∏ –ü—Ä–æ—Ñ–µ—Å–æ—Ä –ø–æ –ò–Ω–∂–µ–Ω–µ—Ä–Ω–∞ –ï–∫–æ–ª–æ–≥–∏—è –≤—ä–≤ –§–∞–∫—É–ª—Ç–µ—Ç '–¢–µ—Ö–Ω–∏–∫–∞ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏' - –Ø–º–±–æ–ª.
–¢–≤–æ—è—Ç–∞ —Ü–µ–ª –µ –¥–∞ –∫–æ–Ω—Å—É–ª—Ç–∏—Ä–∞—à —Å—Ç—É–¥–µ–Ω—Ç–∏ –∫–∞–∫ –¥–∞ –≤–Ω–µ–¥—Ä—è—Ç 'Green-Digital Transition' –≤ –ø—Ä–æ–µ–∫—Ç–∏—Ç–µ —Å–∏.

–ë–ê–ó–ê –ó–ù–ê–ù–ò–Ø (–°—Ç—Ä–∏–∫—Ç–Ω–æ —Å–µ –ø—Ä–∏–¥—ä—Ä–∂–∞–π –∫—ä–º —Ç–µ–∑–∏ —Ç–µ–º–∏ –æ—Ç –∫—É—Ä—Å–∞):
1. –ê–¢–ú–û–°–§–ï–†–ê: –°–ª–µ–¥–∏ –∑–∞ –µ–º–∏—Å–∏–∏ –Ω–∞ –∞–∑–æ—Ç–Ω–∏ –æ–∫—Å–∏–¥–∏ (NOx), –§–ü–ß –∏ –ø–∞—Ä–Ω–∏–∫–æ–≤ –µ—Ñ–µ–∫—Ç.
2. –•–ò–î–†–û–°–§–ï–†–ê: –°–ª–µ–¥–∏ –∑–∞ –µ—É—Ç—Ä–æ—Ñ–∏–∫–∞—Ü–∏—è, –ø—Ä–æ–º—è–Ω–∞ –Ω–∞ —Å–≤–µ—Ç–ª–∏–Ω–Ω–∏—è —Ä–µ–∂–∏–º –∏ pH –Ω–∞ –≤–æ–¥–∏—Ç–µ.
3. –ü–û–ß–í–ò –ò –û–¢–ü–ê–î–™–¶–ò:
   - –°–ª–µ–¥–∏ –∑–∞ '–ø–ª–∞—Å—Ç–æ–≤–∞ –µ—Ä–æ–∑–∏—è' (–æ—Ç–º–∏–≤–∞–Ω–µ –Ω–∞ –ø–æ—á–≤–∞).
   - –°–ª–µ–¥–∏ –∑–∞ '–Ω–∏—Ç—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è' –∏ –∫—Ä—ä–≥–æ–≤—Ä–∞—Ç –Ω–∞ –∞–∑–æ—Ç–∞.
   - –ò–∑–∏—Å–∫–≤–∞–π –º–µ—Ä–∫–∏ —Å—Ä–µ—â—É –∑–∞–º—ä—Ä—Å—è–≤–∞–Ω–µ —Å –º–∏–∫—Ä–æ–ø–ª–∞—Å—Ç–º–∞—Å–∏ (MPs) –∏ –ø–µ—Å—Ç–∏—Ü–∏–¥–∏.

–°–¢–†–£–ö–¢–£–†–ê –ù–ê –ö–û–ù–°–£–õ–¢–ê–¶–ò–Ø–¢–ê:
1. –ö–æ–≥–∞—Ç–æ —Å—Ç—É–¥–µ–Ω—Ç—ä—Ç –≤—ä–≤–µ–¥–µ –ø—Ä–æ–µ–∫—Ç, –Ω–∞–ø—Ä–∞–≤–∏ "–ï–∫–æ-–¥–∏–∞–≥–Ω–æ–∑–∞" (–Ω–∞–º–µ—Ä–∏ —Å–ª–∞–±–∏—è –ø—É–Ω–∫—Ç).
2. –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ "Digital Twin" –∏–ª–∏ "AI/IoT" —Ä–µ—à–µ–Ω–∏–µ –∑–∞ –ø—Ä–æ–±–ª–µ–º–∞.
3. –ì–æ–≤–æ—Ä–∏ –∞–∫–∞–¥–µ–º–∏—á–Ω–æ, –Ω–æ –ø–æ–¥–∫—Ä–µ–ø—è—â–æ. –ù–∞—Å—ä—Ä—á–∞–≤–∞–π –≤—ä–ø—Ä–æ—Å–∏.
"""

def get_gemini_response(history):
    model = genai.GenerativeModel('gemini-1.5-flash', system_instruction=SYSTEM_PROMPT)
    chat = model.start_chat(history=history)
    # –ò–∑–ø—Ä–∞—â–∞–º–µ –ø–æ—Å–ª–µ–¥–Ω–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ, –Ω–æ —Å –∏—Å—Ç–æ—Ä–∏—è—Ç–∞
    response = chat.send_message(history[-1]['parts'][0]) 
    return response.text

# 4. –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–∏ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å (UI)
st.title("üå± AI –ö–æ–Ω—Å—É–ª—Ç–∞–Ω—Ç–∞ –ø–æ –ï–∫–æ–ª–æ–≥–∏—è")
st.markdown("""
**–î–æ–±—Ä–µ –¥–æ—à–ª–∏, –∫–æ–ª–µ–≥–∏!**
–¢–æ–≤–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —â–µ –≤–∏ –ø–æ–º–æ–≥–Ω–µ –¥–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–∞—Ç–µ *–ó–µ–ª–µ–Ω–∏—è –∏ –î–∏–≥–∏—Ç–∞–ª–µ–Ω –ø—Ä–µ—Ö–æ–¥* –≤—ä–≤ –≤–∞—à–∏—Ç–µ –¥–∏–ø–ª–æ–º–Ω–∏ –ø—Ä–æ–µ–∫—Ç–∏.
""")

# –°–∞–π–¥–±–∞—Ä –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞
with st.sidebar:
    st.header("–¢–≤–æ—è—Ç –ø—Ä–æ—Ñ–∏–ª")
    specialty = st.selectbox(
        "–ò–∑–±–µ—Ä–∏ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç:",
        ["–¢–æ–ø–ª–æ- –∏ –≥–∞–∑–æ—Å–Ω–∞–±–¥—è–≤–∞–Ω–µ", "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –Ω–∞ —Ö—Ä–∞–Ω–∏—Ç–µ", "–ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞", "–ï–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏–∫–∞", "–ò–Ω–¥—É—Å—Ç—Ä–∏–∞–ª–Ω–æ –∏–Ω–∂–µ–Ω–µ—Ä—Å—Ç–≤–æ", "–î—Ä—É–≥–∞"]
    )
    st.info("üí° –°—ä–≤–µ—Ç: –û–ø–∏—à–∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å–∏ –¥–µ—Ç–∞–π–ª–Ω–æ, –∑–∞ –¥–∞ –ø–æ–ª—É—á–∏—à –ø–æ-–¥–æ–±—Ä–∞ –æ—Ü–µ–Ω–∫–∞.")

# 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —á–∞—Ç —Å–µ—Å–∏—è—Ç–∞
if "messages" not in st.session_state:
    st.session_state.messages = []
    # –ü—ä—Ä–≤–æ–Ω–∞—á–∞–ª–µ–Ω –ø–æ–∑–¥—Ä–∞–≤ –æ—Ç AI
    intro_msg = f"–ó–¥—Ä–∞–≤–µ–π—Ç–µ, –∫–æ–ª–µ–≥–∞ –æ—Ç —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç **{specialty}**. –ì–æ—Ç–æ–≤ —Å—ä–º –¥–∞ –æ–±—Å—ä–¥–∏–º –≤–∞—à–∏—è –ø—Ä–æ–µ–∫—Ç. –ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ **–ó–∞–≥–ª–∞–≤–∏–µ** –∏ **–ö—Ä–∞—Ç–∫–æ —Ä–µ–∑—é–º–µ**."
    st.session_state.messages.append({"role": "model", "parts": [intro_msg]})

# –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –Ω–∞ —á–∞—Ç–∞
for msg in st.session_state.messages:
    role = "user" if msg["role"] == "user" else "assistant"
    with st.chat_message(role):
        st.markdown(msg["parts"][0])

# 6. –í—Ö–æ–¥ –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
if prompt := st.chat_input("–û–ø–∏—à–∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å–∏ —Ç—É–∫..."):
    # –î–æ–±–∞–≤—è–º–µ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –Ω–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞
    # –î–æ–±–∞–≤—è–º–µ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç—Ç–∞ —Å–∫—Ä–∏—Ç–æ
    full_prompt = f"[–°–ø–µ—Ü–∏–∞–ª–Ω–æ—Å—Ç: {specialty}] {prompt}"
    
    st.session_state.messages.append({"role": "user", "parts": [full_prompt]})
    with st.chat_message("user"):
        st.markdown(prompt)

    # –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä
    with st.chat_message("assistant"):
        with st.spinner("–ü—Ä–æ—Ñ–µ—Å–æ—Ä—ä—Ç –º–∏—Å–ª–∏..."):
            try:
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–≤–∞–Ω–µ –∑–∞ Gemini API —Ñ–æ—Ä–º–∞—Ç
                api_history = [{"role": m["role"].replace("assistant", "model"), "parts": m["parts"]} for m in st.session_state.messages]
                
                # –ò–∑–≤–∏–∫–≤–∞–Ω–µ –Ω–∞ –º–æ–¥–µ–ª–∞
                model = genai.GenerativeModel('gemini-1.5-flash', system_instruction=SYSTEM_PROMPT)
                response = model.generate_content(api_history)
                
                st.markdown(response.text)
                
                # –ó–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞
                st.session_state.messages.append({"role": "model", "parts": [response.text]})
            except Exception as e:
                st.error(f"–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞: {str(e)}")
